<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional JSON Schema Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

    <script>
        // Basic Tailwind dark mode setup
        if (localStorage.getItem('schemaBuilderTheme') === 'dark' || (!('schemaBuilderTheme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }
        .dark body {
            background-color: #111827; /* gray-900 */
        }

        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Resizable panel handle */
        .resizer {
            flex-basis: 6px;
            flex-shrink: 0;
            background-color: #d1d5db; /* gray-300 */
            cursor: col-resize;
            transition: background-color 0.2s ease;
        }
        .dark .resizer {
            background-color: #4b5563; /* gray-600 */
        }
        .resizer:hover {
            background-color: #3b82f6; /* blue-500 */
        }

        /* Card styles for schema items */
        .schema-item-card {
            transition: box-shadow 0.2s ease-in-out;
        }
        
        /* Styling for nested levels to create visual hierarchy */
        .nested-level {
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 2px solid #d1d5db; /* gray-300 */
            margin-top: 0.75rem;
            padding-top: 0.75rem;
        }
        .dark .nested-level {
            border-left-color: #4b5563; /* gray-600 */
        }

        /* Specific border colors for different complex types */
        .nested-level.object-properties { border-left-color: #3b82f6; }
        .nested-level.array-items { border-left-color: #14b8a6; }
        .nested-level.oneof-options { border-left-color: #8b5cf6; }
        .nested-level.defs-properties { border-left-color: #d97706; }

        /* Drag & Drop visual feedback */
        .drag-handle { cursor: grab; }
        .dragging {
            opacity: 0.5;
            background: #e0e7ff; /* indigo-100 */
        }
        .dark .dragging {
            background: #3730a3; /* indigo-800 */
        }
        .drop-zone-active {
            outline: 2px dashed #3b82f6; /* blue-500 */
            outline-offset: 4px;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        /* General input styling */
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
        }
        
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

        /* Collapsible content transition */
        .collapsible-content {
            max-height: 2000px; /* Large enough for content */
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            margin-top: 0 !important;
            opacity: 0;
        }
    </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-200">

    <div id="main-container" class="flex flex-col md:flex-row h-screen w-screen font-sans">
        
        <div id="left-panel" class="flex flex-col bg-white dark:bg-gray-800/50 shadow-lg overflow-y-auto h-full md:h-screen flex-shrink-0">
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm z-20">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">JSON Schema Builder</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Visually create &amp; manage schemas.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="theme-toggle-btn" title="Toggle Dark/Light Mode" aria-label="Toggle Dark/Light Mode" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                            </button>
                    </div>
                </div>
            </header>

            <div class="p-4 space-y-6 flex-grow">
                <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200">Schema Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="schemaTitle" class="text-sm font-medium text-gray-600 dark:text-gray-300">Title</label>
                            <input type="text" id="schemaTitle" placeholder="My Awesome Schema" class="mt-1 p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="rootSchemaTypeSelector" class="text-sm font-medium text-gray-600 dark:text-gray-300">Root Type</label>
                            <select id="rootSchemaTypeSelector" class="mt-1 p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </select>
                        </div>
                    </div>
                    <div>
                        <label for="schemaDescription" class="text-sm font-medium text-gray-600 dark:text-gray-300">Description</label>
                        <textarea id="schemaDescription" rows="3" placeholder="A detailed description of this schema's purpose." class="mt-1 p-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <div id="rootSchemaDefinitionContainer" class="space-y-4">
                    <div id="rootActionControls" class="flex gap-2"></div>
                    <div id="schemaBuilderRoot" class="space-y-4"></div>
                </div>
                
                <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                     <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 flex items-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                          Reusable Definitions ($defs)
                     </h2>
                    <div id="definitionsBuilderRoot" class="space-y-4"></div>
                    <button id="addDefinitionBtn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-amber-600 rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 dark:focus:ring-offset-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Definition
                    </button>
                </div>

            </div>
        </div>

        <div id="resizer" class="resizer hidden md:block"></div>

        <div id="right-panel" class="flex flex-col bg-gray-100 dark:bg-gray-900 h-full md:h-screen flex-grow">
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-y-2 sticky top-0 bg-gray-100/80 dark:bg-gray-900/80 backdrop-blur-sm z-20">
                <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200">Generated Schema</h2>
                <div class="flex items-center flex-wrap justify-end gap-2">
                    <button id="importBtn" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Import
                    </button>
                    <button id="exportBtn" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600">
                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export
                    </button>
                    <button id="copySchemaBtn" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        Copy
                    </button>
                </div>
            </header>

            <div class="flex-grow p-1 relative">
                <pre class="w-full h-full text-sm leading-relaxed bg-gray-800 font-mono overflow-auto focus:outline-none rounded-md"><code id="schemaOutput" class="language-json p-4 block">{}</code></pre>
            </div>
        </div>
    </div>

    <div id="importModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="relative w-full max-w-2xl bg-white dark:bg-gray-800 rounded-lg shadow-xl" id="importModalContent">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Import Schema</h3>
                    <button id="closeImportModalBtn" aria-label="Close import modal" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Paste your JSON schema below or upload a file. This will replace the current schema.</p>
                <textarea id="importSchemaText" rows="10" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600 font-mono text-sm" placeholder='{ "type": "object", ... }'></textarea>
                <div class="mt-6 flex justify-between items-center">
                    <button id="importFileBtn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600">
                        Upload File
                    </button>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                    <button id="parseSchemaBtn" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
                        Parse and Load
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-5 right-5 z-50 w-full max-w-xs space-y-3"></div>

    <script type="module">
        // --- CONSTANTS & CONFIG ---
        const ICONS = {
            sun: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            move: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>`,
            chevronUp: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        };

        const FIELD_TYPES = {
            all: ['$ref', 'string', 'number', 'integer', 'boolean', 'object', 'array', 'oneOf', 'null'],
            root: ['object', 'array', 'oneOf', 'string', 'number', 'integer', 'boolean', 'null'],
            get nonRef() { return this.all.filter(t => t !== '$ref') }
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            rootSchemaType: 'object',
            title: 'Generated Schema',
            description: 'A schema generated by the JSON Schema Builder',
            definitions: [], // For $defs
            schemaDefinition: [], // For root properties/items
            nextId: 0,
            draggedItemId: null,
        };

        // --- DOM ELEMENTS ---
        const dom = {
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            schemaTitle: document.getElementById('schemaTitle'),
            schemaDescription: document.getElementById('schemaDescription'),
            rootSchemaTypeSelector: document.getElementById('rootSchemaTypeSelector'),
            rootActionControls: document.getElementById('rootActionControls'),
            schemaBuilderRoot: document.getElementById('schemaBuilderRoot'),
            definitionsBuilderRoot: document.getElementById('definitionsBuilderRoot'),
            addDefinitionBtn: document.getElementById('addDefinitionBtn'),
            schemaOutput: document.getElementById('schemaOutput'),
            copySchemaBtn: document.getElementById('copySchemaBtn'),
            importBtn: document.getElementById('importBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importModal: document.getElementById('importModal'),
            importModalContent: document.getElementById('importModalContent'),
            closeImportModalBtn: document.getElementById('closeImportModalBtn'),
            importSchemaText: document.getElementById('importSchemaText'),
            importFileInput: document.getElementById('importFileInput'),
            importFileBtn: document.getElementById('importFileBtn'),
            parseSchemaBtn: document.getElementById('parseSchemaBtn'),
            toastContainer: document.getElementById('toastContainer'),
            leftPanel: document.getElementById('left-panel'),
            rightPanel: document.getElementById('right-panel'),
            resizer: document.getElementById('resizer'),
            mainContainer: document.getElementById('main-container'),
        };

        // --- UTILITY & HELPER FUNCTIONS ---
        const createId = () => `item_${appState.nextId++}`;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const icon = type === 'success' ? 
                `<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>` :
                `<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
            
            toast.className = `flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg dark:text-gray-400 dark:bg-gray-800 transform transition-all duration-300 ease-in-out translate-y-4 opacity-0`;
            toast.innerHTML = `
                <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg">${icon}</div>
                <div class="ml-3 text-sm font-normal">${message}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700">
                    <span class="sr-only">Close</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>`;
            
            dom.toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 100);

            const closeBtn = toast.querySelector('button');
            const removeToast = () => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            };

            closeBtn.addEventListener('click', removeToast);
            setTimeout(removeToast, 5000);
        }

        function findItemAndParent(itemId, startNode = appState) {
            const collections = ['schemaDefinition', 'definitions'];
            for (const collectionName of collections) {
                const searchArray = startNode[collectionName];
                if (!Array.isArray(searchArray)) continue;

                for (let i = 0; i < searchArray.length; i++) {
                    const item = searchArray[i];
                    if (item.id === itemId) {
                        return { item, parentArray: searchArray, index: i };
                    }
                    const foundInChildren = findItemAndParent(itemId, item);
                    if (foundInChildren) return foundInChildren;
                }
            }
            // Search within properties, items, oneOfSchemas of the startNode itself
            const subContainers = ['properties', 'items', 'oneOfSchemas'];
            for (const prop of subContainers) {
                if (startNode[prop]) {
                    const container = startNode[prop];
                    if (Array.isArray(container)) {
                         for (let i = 0; i < container.length; i++) {
                            const item = container[i];
                            if (item.id === itemId) {
                                return { item, parentArray: container, index: i };
                            }
                            const foundInChildren = findItemAndParent(itemId, item);
                            if (foundInChildren) return foundInChildren;
                        }
                    } else if (typeof container === 'object' && container.id === itemId) {
                        return { item: container, parentObject: startNode, key: prop };
                    } else if (typeof container === 'object') {
                        const foundInChildren = findItemAndParent(itemId, container);
                        if (foundInChildren) return foundInChildren;
                    }
                }
            }
            return null;
        }

        // --- SCHEMA ITEM CREATION ---
        function createSchemaItem(initialData = {}) {
            const defaultType = 'string';
            const item = {
                id: createId(),
                name: initialData.name || '',
                type: initialData.type || defaultType,
                description: initialData.description || '',
                // Advanced validation fields
                pattern: initialData.pattern || '',
                format: initialData.format || '',
                minLength: initialData.minLength,
                maxLength: initialData.maxLength,
                minimum: initialData.minimum,
                maximum: initialData.maximum,
                exclusiveMinimum: initialData.exclusiveMinimum,
                exclusiveMaximum: initialData.exclusiveMaximum,
                minItems: initialData.minItems,
                maxItems: initialData.maxItems,
                uniqueItems: initialData.uniqueItems || false,
                defaultValue: initialData.defaultValue,
                examples: initialData.examples || '',
                enum: Array.isArray(initialData.enum) ? initialData.enum : [],
                constValue: initialData.constValue,
                ref: initialData.ref || '',
                // Structure
                properties: [],
                items: null,
                oneOfSchemas: [],
                required: initialData.required || false,
                isDefinition: initialData.isDefinition || false,
                // UI State
                isCollapsed: initialData.isCollapsed || false,
            };

            // Initialize nested structures based on type
            if (item.type === 'object') {
                item.properties = Array.isArray(initialData.properties) ? initialData.properties : [];
            } else if (item.type === 'array') {
                if (initialData.items && typeof initialData.items === 'object') {
                    item.items = createSchemaItem(initialData.items);
                } else {
                    item.items = createSchemaItem({ type: 'string' });
                }
            } else if (item.type === 'oneOf') {
                item.oneOfSchemas = Array.isArray(initialData.oneOfSchemas) ? initialData.oneOfSchemas : [];
            }
            
            return item;
        }

        // --- RENDERING LOGIC ---
        function render() {
            // Update global details
            dom.schemaTitle.value = appState.title;
            dom.schemaDescription.value = appState.description;
            dom.rootSchemaTypeSelector.value = appState.rootSchemaType;
            
            // Render root controls and builder area
            renderRootControls();
            dom.schemaBuilderRoot.innerHTML = '';
            if (appState.rootSchemaType === 'object' || appState.rootSchemaType === 'oneOf') {
                if(appState.schemaDefinition.length > 0) {
                    appState.schemaDefinition.forEach(item => dom.schemaBuilderRoot.appendChild(renderItem(item)));
                } else {
                    dom.schemaBuilderRoot.innerHTML = `<div class="text-center py-8 text-gray-500 dark:text-gray-400">No ${appState.rootSchemaType === 'object' ? 'properties' : 'options'} defined.</div>`;
                }
            } else if (appState.rootSchemaType === 'array') {
                dom.schemaBuilderRoot.appendChild(renderItem(appState.schemaDefinition, { isRootArrayItem: true }));
            } else { // Primitives
                dom.schemaBuilderRoot.appendChild(renderItem(appState.schemaDefinition, { isRootPrimitive: true }));
            }

            // Render definitions
            dom.definitionsBuilderRoot.innerHTML = '';
             if(appState.definitions.length > 0) {
                appState.definitions.forEach(def => dom.definitionsBuilderRoot.appendChild(renderItem(def, { isDefinition: true })));
            } else {
                dom.definitionsBuilderRoot.innerHTML = `<div class="text-center py-4 text-gray-500 dark:text-gray-400">No reusable definitions created.</div>`;
            }

            // Generate and display the final schema
            generateAndDisplaySchema();
        }

        function renderRootControls() {
            dom.rootActionControls.innerHTML = '';
            let btnText = '';
            if (appState.rootSchemaType === 'object') btnText = 'Add Root Property';
            else if (appState.rootSchemaType === 'oneOf') btnText = 'Add Root Option';
            
            if (btnText) {
                const addBtn = document.createElement('button');
                addBtn.innerHTML = `${ICONS.plus} ${btnText}`;
                addBtn.className = 'flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800';
                addBtn.addEventListener('click', handleAddRootItem);
                dom.rootActionControls.appendChild(addBtn);
            }
        }
        
        function renderItem(item, options = {}) {
            const { isRootArrayItem = false, isRootPrimitive = false, isDefinition = false, isOneOfOption = false } = options;
            const isRoot = isRootArrayItem || isRootPrimitive;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'schema-item-card bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm';
            itemDiv.dataset.itemId = item.id;
            itemDiv.draggable = !isRoot;

            const isRef = item.type === '$ref';
            const isComplex = ['object', 'array', 'oneOf'].includes(item.type);

            // Determine header text and style
            let headerText = item.name || '(unnamed)';
            let headerClass = 'text-gray-800 dark:text-gray-100';
            if (isDefinition) {
                headerText = item.name || '(unnamed definition)';
                headerClass = 'text-amber-700 dark:text-amber-400';
            } else if (isRootArrayItem) {
                headerText = 'Array Item Schema';
            } else if (isRootPrimitive) {
                headerText = 'Root Schema Details';
            } else if (isOneOfOption) {
                headerText = `oneOf Option (Type: ${isRef ? 'Reference' : item.type})`;
                headerClass = 'text-violet-700 dark:text-violet-400';
            }

            // Available types for the dropdown
            const availableTypes = isOneOfOption ? FIELD_TYPES.all.filter(t => t !== 'oneOf') : FIELD_TYPES.all;
            const typeOptions = availableTypes.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('');
            
            itemDiv.innerHTML = `
                <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        ${!isRoot ? `<span class="drag-handle text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" title="Drag to reorder">${ICONS.move}</span>` : ''}
                        <h3 class="font-semibold ${headerClass}">${headerText}</h3>
                    </div>
                    <div class="flex items-center gap-1">
                         ${isComplex ? `<button data-action="toggleCollapse" title="Collapse/Expand" aria-label="Toggle details section" class="p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">${item.isCollapsed ? ICONS.chevronDown : ICONS.chevronUp}</button>` : ''}
                        ${!isRoot ? `
                        <button data-action="moveUp" title="Move Up" aria-label="Move field up" class="p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">${ICONS.chevronUp}</button>
                        <button data-action="moveDown" title="Move Down" aria-label="Move field down" class="p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">${ICONS.chevronDown}</button>
                        <button data-action="delete" title="Delete" aria-label="Delete field" class="p-1.5 rounded-md text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50">${ICONS.trash}</button>
                        ` : ''}
                    </div>
                </div>

                <div class="collapsible-content ${item.isCollapsed ? 'collapsed' : ''} mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${!isOneOfOption && !isRoot ? `
                        <div>
                            <label for="name_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Name</label>
                            <input type="text" id="name_${item.id}" data-property="name" value="${item.name || ''}" placeholder="${isDefinition ? 'DefinitionName' : 'fieldName'}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>` : ''}
                        
                        <div>
                            <label for="type_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Type</label>
                            <select id="type_${item.id}" data-property="type" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">${typeOptions}</select>
                        </div>
                    </div>
                    
                    <div id="type_specific_${item.id}" class="mt-4 space-y-4">
                        ${isRef ? renderRefInputs(item) : ''}
                        ${!isRef ? `
                        <div>
                            <label for="desc_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Description</label>
                            <textarea id="desc_${item.id}" data-property="description" rows="2" placeholder="Field description..." class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">${item.description || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="default_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Default Value (JSON)</label>
                                <input type="text" id="default_${item.id}" data-property="defaultValue" value="${item.defaultValue !== undefined ? item.defaultValue : ''}" placeholder='"a string", 42, true' class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                            </div>
                            <div>
                                <label for="const_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Constant Value (JSON)</label>
                                <input type="text" id="const_${item.id}" data-property="constValue" value="${item.constValue !== undefined ? item.constValue : ''}" placeholder='"USA", 100, false' class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                            </div>
                        </div>

                        ${item.type === 'string' ? renderStringInputs(item) : ''}
                        ${item.type === 'number' || item.type === 'integer' ? renderNumberInputs(item) : ''}
                        ${item.type === 'array' ? renderArrayInputs(item) : ''}
                        
                        ${!isOneOfOption && !isRoot && !isDefinition ? `
                        <div class="flex items-center pt-2">
                            <input type="checkbox" id="required_${item.id}" data-property="required" ${item.required ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
                            <label for="required_${item.id}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Is Required?</label>
                        </div>
                        ` : ''}
                        ` : ''}
                    </div>

                    <div id="nested_builder_${item.id}" class="mt-4"></div>
                </div>
            `;

            // Render nested builders for complex types
            const nestedBuilder = itemDiv.querySelector(`#nested_builder_${item.id}`);
            if (item.type === 'object') {
                nestedBuilder.appendChild(renderNestedBuilder(item.properties, 'object-properties', 'Property', handleAddNestedItem.bind(null, item.id, 'properties')));
            } else if (item.type === 'array' && item.items) {
                nestedBuilder.appendChild(renderNestedBuilder([item.items], 'array-items', 'Item Schema', null));
            } else if (item.type === 'oneOf') {
                nestedBuilder.appendChild(renderNestedBuilder(item.oneOfSchemas, 'oneof-options', 'Option', handleAddNestedItem.bind(null, item.id, 'oneOfSchemas')));
            }
            
            return itemDiv;
        }

        function renderRefInputs(item) {
            const defOptions = appState.definitions
                .filter(d => d.name) // Only allow referencing named definitions
                .map(d => `<option value="#/$defs/${d.name}" ${item.ref === `#/$defs/${d.name}` ? 'selected' : ''}>${d.name}</option>`)
                .join('');
            return `
                <div>
                    <label for="ref_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Reference ($ref)</label>
                    <select id="ref_${item.id}" data-property="ref" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        <option value="">Select a definition...</option>
                        ${defOptions}
                    </select>
                </div>
            `;
        }
        
        function renderStringInputs(item) {
            return `
                <div class="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-md border border-gray-200 dark:border-gray-700 space-y-4">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300">String Validation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="pattern_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Pattern (RegEx)</label>
                            <input type="text" id="pattern_${item.id}" data-property="pattern" value="${item.pattern || ''}" placeholder="^\\d{3}$" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label for="format_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Format</label>
                            <input type="text" id="format_${item.id}" data-property="format" value="${item.format || ''}" placeholder="email, date-time, etc." class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label for="minLength_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Min Length</label>
                            <input type="number" id="minLength_${item.id}" data-property="minLength" value="${item.minLength !== undefined ? item.minLength : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label for="maxLength_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Max Length</label>
                            <input type="number" id="maxLength_${item.id}" data-property="maxLength" value="${item.maxLength !== undefined ? item.maxLength : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                    </div>
                    <div>
                        <label for="enum_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Enum (comma-separated strings)</label>
                        <textarea id="enum_${item.id}" data-property="enum" rows="2" placeholder="value1, value2" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">${(item.enum || []).join(', ')}</textarea>
                    </div>
                </div>
            `;
        }

        function renderNumberInputs(item) {
            return `
                <div class="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-md border border-gray-200 dark:border-gray-700 space-y-4">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300">Number Validation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="minimum_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Minimum</label>
                            <input type="number" id="minimum_${item.id}" data-property="minimum" value="${item.minimum !== undefined ? item.minimum : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label for="maximum_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Maximum</label>
                            <input type="number" id="maximum_${item.id}" data-property="maximum" value="${item.maximum !== undefined ? item.maximum : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div class="flex items-center pt-2">
                            <input type="checkbox" id="exclusiveMinimum_${item.id}" data-property="exclusiveMinimum" ${item.exclusiveMinimum ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
                            <label for="exclusiveMinimum_${item.id}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Exclusive Minimum</label>
                        </div>
                        <div class="flex items-center pt-2">
                            <input type="checkbox" id="exclusiveMaximum_${item.id}" data-property="exclusiveMaximum" ${item.exclusiveMaximum ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
                            <label for="exclusiveMaximum_${item.id}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Exclusive Maximum</label>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderArrayInputs(item) {
             return `
                <div class="p-3 bg-gray-50 dark:bg-gray-900/50 rounded-md border border-gray-200 dark:border-gray-700 space-y-4">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300">Array Validation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="minItems_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Min Items</label>
                            <input type="number" id="minItems_${item.id}" data-property="minItems" value="${item.minItems !== undefined ? item.minItems : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label for="maxItems_${item.id}" class="text-xs font-medium text-gray-500 dark:text-gray-400">Max Items</label>
                            <input type="number" id="maxItems_${item.id}" data-property="maxItems" value="${item.maxItems !== undefined ? item.maxItems : ''}" class="mt-1 p-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                        </div>
                    </div>
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="uniqueItems_${item.id}" data-property="uniqueItems" ${item.uniqueItems ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
                        <label for="uniqueItems_${item.id}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Unique Items</label>
                    </div>
                </div>
            `;
        }

        function renderNestedBuilder(items, containerClass, addBtnText, addHandler) {
            const containerDiv = document.createElement('div');
            containerDiv.className = `nested-level ${containerClass} space-y-4`;

            if (items.length > 0) {
                items.forEach(nestedItem => {
                    const options = { isOneOfOption: containerClass === 'oneof-options' };
                    containerDiv.appendChild(renderItem(nestedItem, options));
                });
            } else if(addHandler) { // Only show placeholder if items can be added
                 containerDiv.innerHTML = `<div class="text-center py-4 text-sm text-gray-500 dark:text-gray-400">No ${addBtnText.toLowerCase()}s added.</div>`;
            }

            if (addHandler) {
                const addBtn = document.createElement('button');
                addBtn.innerHTML = `${ICONS.plus} Add ${addBtnText}`;
                addBtn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-white bg-gray-500 dark:bg-gray-600 rounded-md hover:bg-gray-600 dark:hover:bg-gray-500';
                addBtn.addEventListener('click', addHandler);
                containerDiv.appendChild(addBtn);
            }
            
            return containerDiv;
        }

        // --- EVENT HANDLERS ---
        function handleGlobalDetailChange(e) {
            const { id, value } = e.target;
            if (id === 'schemaTitle') appState.title = value;
            if (id === 'schemaDescription') appState.description = value;
            generateAndDisplaySchema();
        }

        function handleRootTypeChange(e) {
            appState.rootSchemaType = e.target.value;
            resetSchemaDefinitionForRootType();
            render();
        }

        function resetSchemaDefinitionForRootType() {
            appState.nextId = 0; // Reset IDs to keep them clean for new structure
            const type = appState.rootSchemaType;
            if (type === 'object' || type === 'oneOf') {
                appState.schemaDefinition = [];
            } else if (type === 'array') {
                appState.schemaDefinition = createSchemaItem({ type: 'string' });
            } else { // Primitives
                appState.schemaDefinition = createSchemaItem({ type });
            }
        }
        
        function handleAddRootItem() {
            const isOneOf = appState.rootSchemaType === 'oneOf';
            const newItem = createSchemaItem({ type: 'string' });
            appState.schemaDefinition.push(newItem);
            render();
        }

        function handleAddDefinition() {
            const newDef = createSchemaItem({ isDefinition: true, type: 'object' });
            appState.definitions.push(newDef);
            render();
        }

        function handleAddNestedItem(parentId, property) {
            const found = findItemAndParent(parentId);
            if (found && found.item) {
                const newItem = createSchemaItem({ type: 'string' });
                found.item[property].push(newItem);
                render();
            }
        }
        
        function handleItemUpdate(e) {
            const input = e.target;
            const card = input.closest('.schema-item-card');
            if (!card) return;
            
            const itemId = card.dataset.itemId;
            const property = input.dataset.property;
            let value = input.type === 'checkbox' ? input.checked : input.value;
            
            const found = findItemAndParent(itemId);
            if (!found || !found.item) return;
            
            const item = found.item;
            const oldType = item.type;

            // Type conversions
            if (input.type === 'number') {
                value = value === '' ? undefined : parseFloat(value);
            }
            if (property === 'enum') {
                value = value.split(',').map(s => s.trim()).filter(Boolean);
            }

            item[property] = value;
            
            // If type changed, reset structure and re-render that item
            if (property === 'type' && value !== oldType) {
                // Clear old structure
                item.properties = [];
                item.items = null;
                item.oneOfSchemas = [];
                item.ref = '';
                // Initialize new structure
                if (value === 'object') item.properties = [];
                if (value === 'array') item.items = createSchemaItem({ type: 'string' });
                if (value === 'oneOf') item.oneOfSchemas = [];
                
                // Full re-render is easiest
                render();
            } else {
                // For non-type changes, just regenerate the final schema
                generateAndDisplaySchema();
            }
        }
        
        function handleToggleCollapse(itemId) {
            const found = findItemAndParent(itemId);
            if(found && found.item) {
                found.item.isCollapsed = !found.item.isCollapsed;
                const card = document.querySelector(`[data-item-id="${itemId}"]`);
                if(card) {
                    const content = card.querySelector('.collapsible-content');
                    const icon = card.querySelector('[data-action="toggleCollapse"]');
                    content.classList.toggle('collapsed');
                    icon.innerHTML = found.item.isCollapsed ? ICONS.chevronDown : ICONS.chevronUp;
                }
            }
        }

        function handleDeleteItem(itemId) {
            const found = findItemAndParent(itemId);
            if (found && found.parentArray) {
                found.parentArray.splice(found.index, 1);
                render();
            }
        }

        function handleMoveItem(itemId, direction) {
            const found = findItemAndParent(itemId);
            if (!found || !found.parentArray) return;

            const { parentArray, index } = found;
            const newIndex = direction === 'up' ? index - 1 : index + 1;

            if (newIndex >= 0 && newIndex < parentArray.length) {
                // Swap elements
                [parentArray[index], parentArray[newIndex]] = [parentArray[newIndex], parentArray[index]];
                render();
            }
        }

        // --- DRAG & DROP HANDLERS ---
        function handleDragStart(e) {
            const card = e.target.closest('.schema-item-card');
            if (card) {
                appState.draggedItemId = card.dataset.itemId;
                e.dataTransfer.setData('text/plain', appState.draggedItemId);
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => card.classList.add('dragging'), 0);
            }
        }

        function handleDragEnd(e) {
            const card = e.target.closest('.schema-item-card');
            if (card) card.classList.remove('dragging');
            document.querySelectorAll('.drop-zone-active').forEach(dz => dz.classList.remove('drop-zone-active'));
            appState.draggedItemId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            const card = e.target.closest('.schema-item-card');
            if (card && card.dataset.itemId !== appState.draggedItemId) {
                e.dataTransfer.dropEffect = 'move';
                card.classList.add('drop-zone-active');
            }
        }

        function handleDragLeave(e) {
            const card = e.target.closest('.schema-item-card');
            if (card) card.classList.remove('drop-zone-active');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const targetCard = e.target.closest('.schema-item-card');
            if (targetCard) targetCard.classList.remove('drop-zone-active');

            if (targetCard && appState.draggedItemId && targetCard.dataset.itemId !== appState.draggedItemId) {
                const dragged = findItemAndParent(appState.draggedItemId);
                const target = findItemAndParent(targetCard.dataset.itemId);

                if (dragged && target && dragged.parentArray === target.parentArray) {
                    const itemToMove = dragged.parentArray.splice(dragged.index, 1)[0];
                    target.parentArray.splice(target.index, 0, itemToMove);
                    render();
                } else {
                    showToast("Can only reorder items at the same level.", "error");
                }
            }
        }

        // --- SCHEMA GENERATION & OUTPUT ---
        function buildSchemaFromItem(item) {
            let schema = {};
            
            if (item.type === '$ref') {
                if (item.ref) schema.$ref = item.ref;
                return schema;
            }

            schema.type = item.type;
            if (item.description) schema.description = item.description;
            if (item.defaultValue !== undefined && item.defaultValue !== '') {
                try { schema.default = JSON.parse(item.defaultValue); } 
                catch { schema.default = item.defaultValue; }
            }
            if (item.constValue !== undefined && item.constValue !== '') {
                try { schema.const = JSON.parse(item.constValue); } 
                catch { schema.const = item.constValue; }
            }
            if (item.examples) {
                try { schema.examples = JSON.parse(item.examples); }
                catch { schema.examples = [item.examples]; }
            }

            // Type-specific keywords
            switch(item.type) {
                case 'string':
                    if (item.pattern) schema.pattern = item.pattern;
                    if (item.format) schema.format = item.format;
                    if (item.minLength !== undefined) schema.minLength = item.minLength;
                    if (item.maxLength !== undefined) schema.maxLength = item.maxLength;
                    if (item.enum && item.enum.length > 0) schema.enum = item.enum;
                    break;
                case 'number':
                case 'integer':
                    if (item.minimum !== undefined) schema.minimum = item.minimum;
                    if (item.maximum !== undefined) schema.maximum = item.maximum;
                    if (item.exclusiveMinimum) schema.exclusiveMinimum = item.exclusiveMinimum;
                    if (item.exclusiveMaximum) schema.exclusiveMaximum = item.exclusiveMaximum;
                    break;
                case 'object':
                    if (item.properties && item.properties.length > 0) {
                        schema.properties = {};
                        const requiredFields = [];
                        item.properties.forEach(prop => {
                            if (prop.name) {
                                schema.properties[prop.name] = buildSchemaFromItem(prop);
                                if (prop.required) requiredFields.push(prop.name);
                            }
                        });
                        if (Object.keys(schema.properties).length === 0) delete schema.properties;
                        if (requiredFields.length > 0) schema.required = requiredFields;
                    }
                    break;
                case 'array':
                    if (item.items) schema.items = buildSchemaFromItem(item.items);
                    if (item.minItems !== undefined) schema.minItems = item.minItems;
                    if (item.maxItems !== undefined) schema.maxItems = item.maxItems;
                    if (item.uniqueItems) schema.uniqueItems = true;
                    break;
                case 'oneOf':
                    if (item.oneOfSchemas && item.oneOfSchemas.length > 0) {
                        schema.oneOf = item.oneOfSchemas.map(buildSchemaFromItem);
                        delete schema.type; // oneOf is a keyword, not a type
                    }
                    break;
            }
            return schema;
        }

        function generateAndDisplaySchema() {
            let finalSchema = {
                "$schema": "http://json-schema.org/draft-2020-12/schema#"
            };

            if (appState.title) finalSchema.title = appState.title;
            if (appState.description) finalSchema.description = appState.description;

            // Build root schema
            const rootItem = {
                type: appState.rootSchemaType,
                properties: appState.rootSchemaType === 'object' ? appState.schemaDefinition : [],
                items: appState.rootSchemaType === 'array' ? appState.schemaDefinition : null,
                oneOfSchemas: appState.rootSchemaType === 'oneOf' ? appState.schemaDefinition : [],
                ... ( (appState.rootSchemaType !== 'object' && appState.rootSchemaType !== 'array' && appState.rootSchemaType !== 'oneOf') ? appState.schemaDefinition : {} )
            };
            Object.assign(finalSchema, buildSchemaFromItem(rootItem));

            // Build definitions
            if (appState.definitions.length > 0) {
                finalSchema.$defs = {};
                appState.definitions.forEach(def => {
                    if (def.name) {
                        finalSchema.$defs[def.name] = buildSchemaFromItem(def);
                    }
                });
                if (Object.keys(finalSchema.$defs).length === 0) delete finalSchema.$defs;
            }

            dom.schemaOutput.textContent = JSON.stringify(finalSchema, null, 2);
            // Apply syntax highlighting
            hljs.highlightElement(dom.schemaOutput);
        }

        // --- IMPORT/EXPORT/COPY ---
        async function handleCopySchema() {
            const schemaText = dom.schemaOutput.textContent;
            const originalBtnHTML = dom.copySchemaBtn.innerHTML;

            // Use modern Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(schemaText);
                    showToast("Schema copied to clipboard!");

                    // Visual feedback
                    dom.copySchemaBtn.innerHTML = `${ICONS.check} Copied!`;
                    dom.copySchemaBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    dom.copySchemaBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    
                    setTimeout(() => {
                        dom.copySchemaBtn.innerHTML = originalBtnHTML;
                        dom.copySchemaBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        dom.copySchemaBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 2000);

                } catch (err) {
                    showToast("Failed to copy schema.", "error");
                    console.error('Failed to copy: ', err);
                }
            } else {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = schemaText;
                textArea.style.position = "absolute";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("Schema copied to clipboard!");
                } catch (err) {
                    showToast("Failed to copy schema.", "error");
                }
                document.body.removeChild(textArea);
            }
        }
        
        function handleExportSchema() {
            const schemaText = dom.schemaOutput.textContent;
            const blob = new Blob([schemaText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.title.replace(/[\s/]/g, '_') || 'schema'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function toggleImportModal(show = true) {
            if (show) {
                dom.importModal.classList.remove('hidden');
            } else {
                dom.importModal.classList.add('hidden');
            }
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    dom.importSchemaText.value = e.target.result;
                    showToast(`Loaded ${file.name} successfully.`);
                };
                reader.onerror = () => showToast(`Error reading file.`, "error");
                reader.readAsText(file);
            }
        }
        
        function handleParseAndLoad() {
            const schemaStr = dom.importSchemaText.value;
            if (!schemaStr.trim()) {
                showToast("Import field is empty.", "error");
                return;
            }
            try {
                const importedObj = JSON.parse(schemaStr);
                parseAndLoadRootSchema(importedObj);
                showToast("Schema imported successfully!");
                toggleImportModal(false);
                dom.importSchemaText.value = '';
            } catch (error) {
                showToast(`Error parsing schema: ${error.message}`, "error");
            }
        }

        function parseAndLoadRootSchema(schema) {
            appState.nextId = 0;
            appState.title = schema.title || 'Imported Schema';
            appState.description = schema.description || '';
            appState.definitions = [];
            
            // Parse definitions
            if (schema.$defs) {
                appState.definitions = Object.entries(schema.$defs).map(([name, defSchema]) => {
                    return mapJsonToInternal(defSchema, {name, isDefinition: true});
                });
            }

            // Determine root type and parse
            if (schema.oneOf) {
                appState.rootSchemaType = 'oneOf';
                appState.schemaDefinition = schema.oneOf.map(s => mapJsonToInternal(s));
            } else if (schema.type === 'object' || (!schema.type && schema.properties)) {
                appState.rootSchemaType = 'object';
                const required = schema.required || [];
                appState.schemaDefinition = schema.properties ? Object.entries(schema.properties).map(([name, propSchema]) => {
                    return mapJsonToInternal(propSchema, { name, required: required.includes(name) });
                }) : [];
            } else if (schema.type === 'array') {
                appState.rootSchemaType = 'array';
                appState.schemaDefinition = schema.items ? mapJsonToInternal(schema.items) : createSchemaItem({type: 'string'});
            } else if (FIELD_TYPES.root.includes(schema.type)) {
                appState.rootSchemaType = schema.type;
                appState.schemaDefinition = mapJsonToInternal(schema);
            } else {
                // Fallback for empty or unknown schema
                appState.rootSchemaType = 'object';
                appState.schemaDefinition = [];
            }
            render();
        }

        function mapJsonToInternal(schemaPart, options = {}) {
            const { name = '', required = false, isDefinition = false } = options;
            
            let type = schemaPart.type;
            if (schemaPart.$ref) type = '$ref';
            if (schemaPart.oneOf) type = 'oneOf';
            if (!type && schemaPart.properties) type = 'object';


            const internalItem = createSchemaItem({
                name,
                type,
                description: schemaPart.description,
                pattern: schemaPart.pattern,
                format: schemaPart.format,
                minLength: schemaPart.minLength,
                maxLength: schemaPart.maxLength,
                minimum: schemaPart.minimum,
                maximum: schemaPart.maximum,
                exclusiveMinimum: schemaPart.exclusiveMinimum,
                exclusiveMaximum: schemaPart.exclusiveMaximum,
                minItems: schemaPart.minItems,
                maxItems: schemaPart.maxItems,
                uniqueItems: schemaPart.uniqueItems,
                defaultValue: schemaPart.default !== undefined ? JSON.stringify(schemaPart.default) : undefined,
                examples: schemaPart.examples !== undefined ? JSON.stringify(schemaPart.examples) : undefined,
                enum: schemaPart.enum,
                constValue: schemaPart.const !== undefined ? JSON.stringify(schemaPart.const) : undefined,
                ref: schemaPart.$ref,
                required,
                isDefinition,
            });

            if (type === 'object' && schemaPart.properties) {
                const nestedRequired = schemaPart.required || [];
                internalItem.properties = Object.entries(schemaPart.properties).map(([propName, propSchema]) => {
                    return mapJsonToInternal(propSchema, { name: propName, required: nestedRequired.includes(propName) });
                });
            } else if (type === 'array' && schemaPart.items) {
                internalItem.items = mapJsonToInternal(schemaPart.items);
            } else if (type === 'oneOf' && schemaPart.oneOf) {
                internalItem.oneOfSchemas = schemaPart.oneOf.map(s => mapJsonToInternal(s));
            }
            
            return internalItem;
        }

        // --- THEME TOGGLE ---
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('schemaBuilderTheme', isDark ? 'dark' : 'light');
            dom.themeToggleBtn.innerHTML = isDark ? ICONS.sun : ICONS.moon;
        }

        // --- RESIZABLE PANELS ---
        function initResizablePanels() {
            const resizer = dom.resizer;
            const left = dom.leftPanel;
            const right = dom.rightPanel;

            // Restore saved width
            const savedWidth = localStorage.getItem('schemaBuilderLeftPanelWidth');
            if (savedWidth) {
                left.style.flexBasis = savedWidth;
            } else {
                left.style.flexBasis = '50%'; // Default to 50% if no saved width
            }

            const mouseMoveHandler = (e) => {
                // Prevent selection while dragging
                e.preventDefault();
                const containerRect = dom.mainContainer.getBoundingClientRect();
                const newLeftWidth = e.clientX - containerRect.left;

                // Enforce min/max widths
                if (newLeftWidth > 300 && newLeftWidth < (containerRect.width - 300)) {
                    left.style.flexBasis = `${newLeftWidth}px`;
                }
            };

            const mouseUpHandler = () => {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                 // Save final width
                localStorage.setItem('schemaBuilderLeftPanelWidth', left.style.flexBasis);
            };

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            });
        }


        // --- INITIALIZATION ---
        function init() {
            // Populate selects
            dom.rootSchemaTypeSelector.innerHTML = FIELD_TYPES.root.map(t => `<option value="${t}">${t}</option>`).join('');

            // Set initial theme
            const isDark = document.documentElement.classList.contains('dark');
            dom.themeToggleBtn.innerHTML = isDark ? ICONS.sun : ICONS.moon;
            
            // Add event listeners
            dom.themeToggleBtn.addEventListener('click', toggleTheme);
            dom.schemaTitle.addEventListener('input', handleGlobalDetailChange);
            dom.schemaDescription.addEventListener('input', handleGlobalDetailChange);
            dom.rootSchemaTypeSelector.addEventListener('change', handleRootTypeChange);
            dom.addDefinitionBtn.addEventListener('click', handleAddDefinition);
            dom.copySchemaBtn.addEventListener('click', handleCopySchema);
            dom.exportBtn.addEventListener('click', handleExportSchema);
            
            // Modal listeners
            dom.importBtn.addEventListener('click', () => toggleImportModal(true));
            dom.closeImportModalBtn.addEventListener('click', () => toggleImportModal(false));
            dom.importFileBtn.addEventListener('click', () => dom.importFileInput.click());
            dom.importFileInput.addEventListener('change', handleImportFile);
            dom.parseSchemaBtn.addEventListener('click', handleParseAndLoad);
            dom.importModal.addEventListener('click', (e) => {
                if (e.target === dom.importModal) toggleImportModal(false);
            });

            // Event delegation for dynamic content in the builder panel
            const builderPanel = dom.leftPanel;
            builderPanel.addEventListener('input', e => {
                if (e.target.matches('input, select, textarea')) {
                    handleItemUpdate(e);
                }
            });
            builderPanel.addEventListener('change', e => {
                 if (e.target.matches('input[type="checkbox"]')) {
                    handleItemUpdate(e);
                }
            });
            builderPanel.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                const action = button.dataset.action;
                const card = button.closest('.schema-item-card');
                if (card && action) {
                    const itemId = card.dataset.itemId;
                    if (action === 'delete') handleDeleteItem(itemId);
                    if (action === 'moveUp') handleMoveItem(itemId, 'up');
                    if (action === 'moveDown') handleMoveItem(itemId, 'down');
                    if (action === 'toggleCollapse') handleToggleCollapse(itemId);
                }
            });
            builderPanel.addEventListener('dragstart', handleDragStart);
            builderPanel.addEventListener('dragend', handleDragEnd);
            builderPanel.addEventListener('dragover', handleDragOver);
            builderPanel.addEventListener('dragleave', handleDragLeave);
            builderPanel.addEventListener('drop', handleDrop);

            // Initialize resizable panels
            initResizablePanels();

            // Initial setup and render
            resetSchemaDefinitionForRootType();
            render();
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
